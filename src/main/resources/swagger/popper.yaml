openapi: 3.0.3
info:
  title: Popper
  description: Backend spec for popper app
  version: 0.2.0

servers:
  - url: 'http://0.0.0.0:8080'
  - url: 'http://213.226.126.220:8080'
  - url: 'https://webpanel.remcoil.space/'
paths:

  /bobbin:
    get:
      tags:
        - bobbin
      responses:
        '200':
          description: List of all bobbins
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListOfBobbins'
    post:
      tags:
        - bobbin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Bobbin'
      responses:
        '200':
          description: Task created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Bobbin'
        '400':
          description: Bad Request

  /bobbin/{id}:
    get:
      tags:
        - bobbin
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: number
      responses:
        '200':
          description: Bobbin information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Bobbin'
        '404':
          description: Bobbin not found
        '400':
          description: Bad request

    delete:
      tags:
        - bobbin
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: number
      responses:
        '200':
          description: Bobbin marked as defected
        '404':
          description: Bobbin not found
        '400':
          description: Bad request

  /bobbin/{id}/delete:
    delete:
      tags:
        - bobbin
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: number
      responses:
        '200':
          description: Bobbin deleted
        '400':
          description: Bad request

  /batch/bobbins/{batch_id}:
    get:
      tags:
        - bobbin
      parameters:
        - in: path
          name: batch_id
          required: true
          schema:
            type: number
      responses:
        '200':
          description: List of bobbins of one batch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListOfBobbins'
        '400':
          description: Bad request
        '404':
          description: Not Found

  /task/bobbins/{task_id}:
    get:
      tags:
        - bobbin
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: List of bobbins of one task
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListOfBobbins'
        '400':
          description: Bad Request
        '404':
          description: Not Found

  /task:
    get:
      tags:
        - task
      responses:
        '200':
          description: List of tasks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListOfTasks'

    put:
      tags:
        - task
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Task'
      responses:
        '200':
          description: Task updated
        '400':
          description: Bad request

    post:
      tags:
        - task
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskIdentity'
      responses:
        '200':
          description: Task created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'

  /task/{id}:
    get:
      tags:
        - task
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Task information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '400':
          description: Task not found

    delete:
      tags:
        - task
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Task deleted successfully

  /task/full:
    get:
      tags:
        - task
      responses:
        '200':
          description: List of full tasks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListOfFullTasks'

  /task/full/{id}:
    get:
      tags:
        - task
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Task full information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListOfFullTasks'


  /batch:
    get:
      tags:
        - batch
      responses:
        '200':
          description: List of batches
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListOfBatch'
    post:
      tags:
        - batch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchIdentity'
      responses:
        '400':
          description: Bad request
        '200':
          description: Batch created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Action'

  /batch/{id}:
    get:
      tags:
        - batch
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: number
      responses:
        '200':
          description: Batch information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Batch'
        '400':
          description: Batch not found

    delete:
      tags:
        - batch
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: number
      responses:
        '200':
          description: Batch deleted successfully

  /batch/task/{task_id}:
    get:
      tags:
        - batch
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: number
      responses:
        '200':
          description: Batch information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListOfBatch'
        '400':
          description: Batch not found

  /batch/full/{id}:
    get:
      tags:
        - batch
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: number
      responses:
        '200':
          description: Batch full information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FullBatch'
        '400':
          description: Batch not found

  /batch/full:
    get:
      tags:
        - batch
      responses:
        '200':
          description: List of full batches
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListOfFullBatches'

  /batch/codes/{batch_id}:
    get:
      tags:
        - batch
      parameters:
        - in: path
          name: batch_id
          required: true
          schema:
            type: number
      responses:
        '200':
          description: Bobbin's QR codes by batch

  /action:
    get:
      tags:
        - action
      responses:
        '200':
          description: List of actions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListOfActions'

    post:
      security:
        - bearerAuth: [ ]
      tags:
        - action
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActionDto'
      responses:
        '400':
          description: Bad request
        '200':
          description: Action created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Action'
    put:
      tags:
        - action
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Action'
      responses:
        '200':
          description: Action update
        '400':
          description: Bad request

  /action/batch:
    post:
      security:
        - bearerAuth: [ ]
      tags:
        - batch action
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchAction'
      responses:
        '400':
          description: Bad request
        '200':
          description: Action created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListOfActions'

  /action/bobbin/{bobbin_id}:
    get:
      tags:
        - action
      parameters:
        - in: path
          name: bobbin_id
          required: true
          schema:
            type: number
      responses:
        '200':
          description: Full list of one bobbin actions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListOfActions'

  /action/{id}:
    delete:
      tags:
        - action
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: number
      responses:
        '200':
          description: Action deleted successfully

  /action/full:
    get:
      tags:
        - full action
      responses:
        '200':
          description: List of flat full actions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListOfFlatFullActions'

  /action/full/task/{task_id}:
    get:
      tags:
        - full action
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Task full action
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskFullAction'

  /action/full/batch/{batch_id}:
    get:
      tags:
        - full action
      parameters:
        - in: path
          name: batch_id
          required: true
          schema:
            type: number
      responses:
        '200':
          description: Batch full action
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchFullAction'

  /action/full/bobbin/{bobbin_id}:
    get:
      tags:
        - full action
      parameters:
        - in: path
          name: bobbin_id
          required: true
          schema:
            type: number
      responses:
        '200':
          description: Bobbin full action
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BobbinFullAction'

  /action/full/{id}:
    get:
      tags:
        - full action
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: number
      responses:
        '200':
          description: Flat full action
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FlatFullAction'

  /comment:
    get:
      tags:
        - comment
      responses:
        '200':
          description: List of all comments
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListOfComments'

    post:
      security:
        - bearerAuth: [ ]
      tags:
        - comment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Comment'
      responses:
        '200':
          description: Comment created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'

    put:
      security:
        - bearerAuth: [ ]
      tags:
        - comment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Comment'
      responses:
        '200':
          description: Comment update


  /comment/{action_id}:
    get:
      tags:
        - comment
      parameters:
        - in: path
          name: action_id
          required: true
          schema:
            type: number
      responses:
        '204':
          description: No content
        '200':
          description: Defect Comment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/omment'

    delete:
      security:
        - bearerAuth: [ ]
      tags:
        - comment
      parameters:
        - in: path
          name: action_id
          required: true
          schema:
            type: number
      responses:
        '200':
          description: Comment deleted successfully


  /operator?active_only=true:
    get:
      tags:
        - operator
      parameters:
        - in: query
          name: active_only
          schema:
            type: boolean
      responses:
        '200':
          description: List of operators
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListOfOperators'

  /operator/state/{id}?active:
    put:
      tags:
        - operator
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
        - in: query
          name: active
          required: true
          schema:
            type: boolean
      responses:
        '200':
          description: Operator state updated
        '404':
          description: Operator not found


  /operator/{id}:
    delete:
      tags:
        - operator
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Operator deleted successfully

  /operator/sign_in:
    post:
      tags:
        - operator
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Credentials'
      responses:
        '401':
          description: Wrong password or phone
        '200':
          description: A JSON array of user names
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Token'

  /operator/sign_up:
    post:
      tags:
        - operator
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Operator'
      responses:
        '200':
          description: A JSON array of user names
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Token'
        '400':
          description: Operator already exists

  /operator:
    put:
      tags:
        - operator
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Operator'
      responses:
        '200':
          description: Operator updated
        '400':
          description: Bad request

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    TaskFullAction:
      properties:
        id:
          type: number
        task_name:
          type: string
        task_number:
          type: string
        batches:
          type: array
          items:
            $ref: '#/components/schemas/BatchFullAction'

    BatchFullAction:
      properties:
        id:
          type: number
        batch_number:
          type: string
        bobbins:
          type: array
          items:
            $ref: '#/components/schemas/BobbinFullAction'

    BobbinFullAction:
      properties:
        id:
          type: number
        bobbin_number:
          type: string
        is_active_bobbin:
          type: boolean
        actions:
          type: array
          items:
            $ref: '#/components/schemas/FullAction'

    FullAction:
      properties:
        action_id:
          type: number
        action_type:
          type: string
        done_time:
          type: string
        successful:
          type: boolean
        comment:
          type: string
        operator_id:
          type: integer
        first_name:
          type: string
        second_name:
          type: string
        surname:
          type: string

    FlatFullAction:
      properties:
        task_id:
          type: integer
        task_name:
          type: string
        task_number:
          type: string
        batch_id:
          type: number
        batch_number:
          type: string
        bobbin_id:
          type: number
        bobbin_number:
          type: integer
        is_active_bobbin:
          type: boolean
        action_id:
          type: number
        action_type:
          type: string
        done_time:
          type: string
        successful:
          type: boolean
        comment:
          type: string
        operator_id:
          type: integer
        first_name:
          type: string
        second_name:
          type: string
        surname:
          type: string

    Action:
      properties:
        id:
          type: number
        operator_id:
          type: integer
        bobbin_id:
          type: integer
        action_type:
          type: string
        done_time:
          type: string
        successful:
          type: boolean

    BatchAction:
      properties:
        id:
          type: number
        batch_id:
          type: integer
        action_type:
          type: string
        done_time:
          type: string
        successful:
          type: boolean

    ActionDto:
      properties:
        id:
          type: number
        bobbin_id:
          type: integer
        action_type:
          type: string
        done_time:
          type: string
        successful:
          type: boolean

    Token:
      properties:
        token:
          type: string

    Task:
      properties:
        id:
          type: integer
        task_name:
          type: string
        task_number:
          type: string

    FullTask:
      properties:
        id:
          type: integer
        task_name:
          type: string
        task_number:
          type: string
        batches:
          $ref: '#/components/schemas/ListOfFullBatches'

    Operator:
      properties:
        id:
          type: integer
        first_name:
          type: string
        second_name:
          type: string
        surname:
          type: string
        phone:
          type: string
        password:
          type: string
        active:
          type: boolean
        role:
          type: string

    Bobbin:
      properties:
        id:
          type: number
        batch_id:
          type: number
        bobbin_number:
          type: integer
        active:
          type: boolean

    Batch:
      properties:
        id:
          type: number
        task_id:
          type: integer
        batch_number:
          type: string

    BatchIdentity:
      properties:
        task_id:
          type: integer

    FullBatch:
      properties:
        id:
          type: number
        task_id:
          type: integer
        batch_number:
          type: string
        quantity:
          type: integer
        winding:
          type: integer
        output:
          type: integer
        isolation:
          type: integer
        molding:
          type: integer
        crimping:
          type: integer
        quality:
          type: integer
        testing:
          type: integer


    ListOfActions:
      type: array
      items:
        $ref: '#/components/schemas/Action'

    ListOfFlatFullActions:
      type: array
      items:
        $ref: '#/components/schemas/FlatFullAction'

    ListOfBobbins:
      type: array
      items:
        $ref: '#/components/schemas/Bobbin'

    ListOfOperators:
      type: array
      items:
        $ref: '#/components/schemas/Operator'

    ListOfTasks:
      type: array
      items:
        $ref: '#/components/schemas/Task'

    ListOfFullTasks:
      type: array
      items:
        $ref: '#/components/schemas/FullTask'

    ListOfBatch:
      type: array
      items:
        $ref: '#/components/schemas/Batch'

    ListOfFullBatches:
      type: array
      items:
        $ref: '#/components/schemas/FullBatch'

    ListOfComments:
      type: array
      items:
        $ref: '#/components/schemas/Comment'

    TaskIdentity:
      properties:
        task_name:
          type: string
        task_number:
          type: string
        batch_number:
          type: integer
        batch_size:
          type: integer

    Credentials:
      properties:
        phone:
          type: string
        password:
          type: string

    Comment:
      properties:
        action_id:
          type: number
        comment:
          type: string
